name: Deploy Changed Lambda Functions

on:
    push:
        branches:
            - main
        paths:
            - "lambda/functions/**.ts"
    workflow_dispatch:
        inputs:
            specific_file:
                description: "ç‰¹å®šã®TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ãƒ‘ã‚¹ã‚’æŒ‡å®šï¼ˆä¾‹: lambda/functions/test.tsï¼‰"
                required: false
                default: "lambda/functions/test.ts"

jobs:
    deploy-changed-functions:
        name: Build and Deploy Changed Functions
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get changed TypeScript files
              id: changed-files
              uses: tj-actions/changed-files@v44
              with:
                  files: lambda/functions/**.ts

            - name: Set changed files or use input
              id: set-files
              run: |
                  if [[ -n "${{ github.event.inputs.specific_file }}" ]]; then
                    echo "Changed files overridden by manual input: ${{ github.event.inputs.specific_file }}"
                    echo "files=${{ github.event.inputs.specific_file }}" >> $GITHUB_OUTPUT
                  else
                    CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
                    echo "Detected changed files: $CHANGED_FILES"
                    echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
                  fi

            - name: Check for changes
              id: check-changes
              run: |
                  if [[ -z "${{ steps.set-files.outputs.files }}" ]]; then
                    echo "No files to process."
                    echo "any_changed=false" >> $GITHUB_OUTPUT
                  else
                    echo "Files to process: ${{ steps.set-files.outputs.files }}"
                    echo "any_changed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Set up Node.js
              if: steps.check-changes.outputs.any_changed == 'true'
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: lambda/functions/package-lock.json

            - name: Configure AWS credentials
              if: steps.check-changes.outputs.any_changed == 'true'
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Install Lambda dependencies
              if: steps.check-changes.outputs.any_changed == 'true'
              working-directory: lambda/functions
              run: npm ci

            - name: Build and Deploy changed functions
              if: steps.check-changes.outputs.any_changed == 'true'
              id: deploy-functions
              env:
                  CHANGED_FILES: ${{ steps.set-files.outputs.files }}
              run: |
                  echo "AWS CLI version: $(aws --version)"
                  echo "Files to process: $CHANGED_FILES"
                  BUILD_TEMP_DIR="./lambda_deploy_temp"
                  mkdir -p $BUILD_TEMP_DIR

                  DEPLOYED_FUNCTIONS_JSON="["
                  FIRST_FUNCTION=true

                  for ts_file_path in $CHANGED_FILES; do
                    echo "--------------------------------------------------"
                    echo "Processing function: $ts_file_path"
                    echo "--------------------------------------------------"
                    
                    if [ ! -f "$ts_file_path" ]; then
                      echo "  [ERROR] File does not exist: $ts_file_path. Skipping." >&2
                      continue
                    fi
                    
                    relative_path=$(echo "$ts_file_path" | sed 's|^lambda/functions/||')
                    path_no_ext=$(echo "$relative_path" | sed 's|\.ts$||')
                    function_name_suffix=$(echo "$path_no_ext" | tr '/' '-')
                    aws_function_name="lambda-functions-${function_name_suffix}"
                    build_output_dir="${BUILD_TEMP_DIR}/${function_name_suffix}"
                    zip_file_path="${BUILD_TEMP_DIR}/${function_name_suffix}.zip"
                    output_js_file="index.js"
                    lambda_handler="${output_js_file%.*}.handler"
                    
                    echo "  Target AWS Lambda Function Name: $aws_function_name"
                    echo "  Build Output Directory: $build_output_dir"
                    echo "  Deployment Package (ZIP): $zip_file_path"
                    echo "  Expected Lambda Handler: $lambda_handler"
                    
                    echo "  Building TypeScript to JavaScript..."
                    mkdir -p "$build_output_dir"
                    DEPLOY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                    
                    npx esbuild "${ts_file_path}" --bundle "--outfile=${build_output_dir}/${output_js_file}" --platform=node --format=cjs --external:@aws-sdk/* --minify --sourcemap --banner:js="// Deployed at: ${DEPLOY_TIMESTAMP}" --define:__DEPLOYMENT_TIMESTAMP__="'${DEPLOY_TIMESTAMP}'"
                    
                    if [ $? -ne 0 ]; then
                        echo "  [ERROR] esbuild failed for $ts_file_path. Aborting deployment." >&2
                        exit 1
                    fi
                    
                    echo "  Checking build output..."
                    ls -la "${build_output_dir}/"
                    
                    if [ ! -f "${build_output_dir}/${output_js_file}" ]; then
                        echo "  [ERROR] Expected output file '${build_output_dir}/${output_js_file}' not found. Aborting deployment." >&2
                        exit 1
                    fi
                    
                    echo "  Build successful: ${build_output_dir}/${output_js_file}"
                    echo "  Creating deployment package..."
                    
                    (cd "$build_output_dir" && zip -r "../${function_name_suffix}.zip" index.js index.js.map)
                    
                    if [ $? -ne 0 ]; then
                        echo "  [ERROR] Failed to create zip package '$zip_file_path' for $ts_file_path. Aborting deployment." >&2
                        exit 1
                    fi
                    
                    if [ ! -f "$zip_file_path" ]; then
                         echo "  [ERROR] Zip package '$zip_file_path' not found after zip command. Aborting deployment." >&2
                         exit 1
                    fi
                    
                    echo "  Checking zip file contents:"
                    unzip -l "$zip_file_path"
                    
                    echo "  Deployment package created: $zip_file_path"
                    
                    if aws lambda get-function --function-name "$aws_function_name" &>/dev/null; then
                        echo "  Updating existing Lambda function '$aws_function_name'..."
                        aws lambda update-function-code \
                          --function-name "$aws_function_name" \
                          --zip-file "fileb://$zip_file_path" \
                          --publish
                    else
                        echo "  Creating new Lambda function '$aws_function_name'..."
                        aws lambda create-function \
                          --function-name "$aws_function_name" \
                          --runtime "nodejs18.x" \
                          --role "${{ secrets.LAMBDA_EXECUTION_ROLE }}" \
                          --handler "$lambda_handler" \
                          --zip-file "fileb://$zip_file_path" \
                          --timeout 30 \
                          --memory-size 256
                    fi
                    
                    if [ $? -ne 0 ]; then
                        echo "  [ERROR] Failed to deploy function '$aws_function_name'. Aborting deployment." >&2
                        exit 1
                    else
                        echo "  Successfully deployed function '$aws_function_name'."
                    fi
                    
                    echo "  Configuring Lambda Function URL..."
                    
                    if aws lambda get-function-url-config --function-name "$aws_function_name" &>/dev/null; then
                        echo "  Function URL already exists for '$aws_function_name', skipping creation."
                    else
                        echo "  Creating Function URL for '$aws_function_name'..."
                        aws lambda create-function-url-config \
                          --function-name "$aws_function_name" \
                          --auth-type "NONE" \
                          --cors '{"AllowOrigins": ["*"], "AllowMethods": ["*"], "AllowHeaders": ["*"], "ExposeHeaders": ["*"]}'
                        
                        aws lambda add-permission \
                          --function-name "$aws_function_name" \
                          --statement-id "FunctionURLAllowPublicAccess" \
                          --action "lambda:InvokeFunctionUrl" \
                          --principal "*" \
                          --function-url-auth-type "NONE"
                    fi
                    
                    FUNCTION_URL=$(aws lambda get-function-url-config --function-name "$aws_function_name" --query "FunctionUrl" --output text)
                    echo "  Function URL: $FUNCTION_URL"
                    
                    if [ "$FIRST_FUNCTION" = true ]; then
                      FIRST_FUNCTION=false
                    else
                      DEPLOYED_FUNCTIONS_JSON="${DEPLOYED_FUNCTIONS_JSON},"
                    fi
                    
                    DEPLOYED_FUNCTIONS_JSON="${DEPLOYED_FUNCTIONS_JSON}{\"name\":\"${aws_function_name}\",\"file\":\"${ts_file_path}\",\"url\":\"${FUNCTION_URL}\"}"
                    
                  done

                  DEPLOYED_FUNCTIONS_JSON="${DEPLOYED_FUNCTIONS_JSON}]"
                  echo "deployed_functions_json=${DEPLOYED_FUNCTIONS_JSON}" >> $GITHUB_OUTPUT

                  echo "--------------------------------------------------"
                  echo "Cleaning up temporary build directory..."
                  rm -rf $BUILD_TEMP_DIR
                  echo "Deployment process finished successfully."

            - name: Send Notification to Discord
              if: steps.check-changes.outputs.any_changed == 'true'
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
                  DEPLOYED_FUNCTIONS_JSON: ${{ steps.deploy-functions.outputs.deployed_functions_json }}
                  GITHUB_ACTOR: ${{ github.actor }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
                  GITHUB_SHA: ${{ github.sha }}
                  GITHUB_RUN_ID: ${{ github.run_id }}
              run: |
                  if [ -z "$DISCORD_WEBHOOK_URL" ]; then
                    echo "DISCORD_WEBHOOK_URL is not set. Skipping Discord notification."
                    exit 0
                  fi

                  echo "Preparing Discord notification..."

                  function escape_html() {
                    echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&apos;/g'
                  }

                  FUNCTIONS_CONTENT=""
                  FUNCTIONS_COUNT=$(echo $DEPLOYED_FUNCTIONS_JSON | jq '. | length')

                  for i in $(seq 0 $(($FUNCTIONS_COUNT-1))); do
                    FUNCTION_NAME=$(echo $DEPLOYED_FUNCTIONS_JSON | jq -r ".[$i].name")
                    FUNCTION_FILE=$(echo $DEPLOYED_FUNCTIONS_JSON | jq -r ".[$i].file")
                    FUNCTION_URL=$(echo $DEPLOYED_FUNCTIONS_JSON | jq -r ".[$i].url")
                    
                    FORMATTED_URL=$(echo "$FUNCTION_URL" | sed 's/lambda-url\.\([^.]*\)\.on\.aws/lambda-url.ap-northeast-1.on.aws/')
                    
                    FUNCTIONS_CONTENT="${FUNCTIONS_CONTENT}**Function:** \`${FUNCTION_NAME}\`\n"
                    FUNCTIONS_CONTENT="${FUNCTIONS_CONTENT}**Source File:** \`${FUNCTION_FILE}\`\n"
                    FUNCTIONS_CONTENT="${FUNCTIONS_CONTENT}**URL:** ${FORMATTED_URL}\n\n"
                  done

                  COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
                  WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
                  SHORT_SHA="${GITHUB_SHA:0:7}"

                  read -r -d '' DISCORD_JSON << EOM
                  {
                    "embeds": [
                      {
                        "title": "ðŸš€ Lambda Functions Deployed",
                        "description": "Lambda Function URLsãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚",
                        "color": 3447003,
                        "fields": [
                          {
                            "name": "Function URLs",
                            "value": "$FUNCTIONS_CONTENT"
                          },
                          {
                            "name": "Deployment Details",
                            "value": "**Repository:** $GITHUB_REPOSITORY\n**Commit:** [$SHORT_SHA]($COMMIT_URL)\n**Workflow:** [View Workflow Run]($WORKFLOW_URL)\n**Triggered by:** $GITHUB_ACTOR"
                          }
                        ],
                        "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")"
                      }
                    ]
                  }
                  EOM

                  echo "Sending notification to Discord..."
                  curl -X POST \
                    -H "Content-Type: application/json" \
                    -d "$DISCORD_JSON" \
                    "$DISCORD_WEBHOOK_URL"

                  echo "Discord notification sent!"
